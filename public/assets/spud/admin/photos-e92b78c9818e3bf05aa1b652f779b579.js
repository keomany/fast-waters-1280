Spud="undefined"==typeof Spud?{}:Spud,Spud.Admin="undefined"==typeof Spud.Admin?{}:Spud.Admin,Spud.Admin.Photos=new function(){var o=this,e=!1;this.init=function(){if($(".spud_admin_photo_ui_thumbs_sortable").sortable({connectWith:".spud_admin_photo_ui_thumbs_sortable"}),$("body").on("submit","#spud_admin_photo_album_form",o.submittedPhotoAlbumForm),$("body").on("submit","#spud_admin_photo_gallery_form",o.submittedPhotoGalleryForm),$("body").on("submit","#spud_admin_photo_form",o.submittedPhotoForm),$("body").on("click",".spud_admin_photos_btn_remove",o.clickedPhotoRemoveFromAlbum),$("body").on("click",".spud_admin_photo_ui_thumbs_selectable .spud_admin_photo_ui_thumb",o.selectedPhotoUiThumb),$("body").on("click","#spud_admin_photo_album_action_library",o.clickedPhotoLibrary),$("body").on("click","#spud_admin_photo_album_action_upload, .spud_admin_photo .spud_admin_photos_btn_edit",o.clickedPhotoAddOrEdit),$("body").on("click",".spud_admin_photo_library_add_selected",o.addSelectedPhotosFromLibrary),$("body").on("click",".spud_admin_photo_library_delete_selected",o.deleteSelectedPhotosFromLibrary),"undefined"!=typeof FormData&&"undefined"!=typeof XMLHttpRequest&&(droparea=document.getElementById("spud_admin_photo_upload_queue"))){e=!0,$("#spud_admin_photo_upload_queue").show(),droparea.addEventListener("dragenter",o.stopDndPropagation,!1),droparea.addEventListener("dragexit",o.stopDndPropagation,!1),droparea.addEventListener("dragover",o.stopDndPropagation,!1),droparea.addEventListener("drop",o.droppedFile,!1);var t=document.getElementsByTagName("body")[0];t.addEventListener("dragenter",o.stopDndPropagation,!1),t.addEventListener("dragexit",o.stopDndPropagation,!1),t.addEventListener("dragover",o.stopDndPropagation,!1),t.addEventListener("drop",o.stopDndPropagation,!1)}},this.submittedPhotoAlbumForm=function(){},this.submittedPhotoGalleryForm=function(){$("#spud_admin_photo_albums_available .spud_admin_photo_ui_thumb").remove()},this.clickedPhotoRemoveFromAlbum=function(){return $(this).parents(".spud_admin_photo_ui_thumb").fadeOut(200,function(){$(this).remove()}),!1},this.photoLegacyUploadErrors=function(o){$("#spud_admin_photo_form").replaceWith(o)},this.photoLegacyUploadComplete=function(o,e){var t=$("#spud_admin_photo_"+o);if(t.length>0)t.replaceWith(e);else{var d=$("#spud_admin_photos_selected, #spud_admin_photos");d.prepend(e)}hideModalDialog()},this.selectedPhotoUiThumb=function(){var o=$(this);o.hasClass("spud_admin_photo_ui_thumb_selected")?$(this).removeClass("spud_admin_photo_ui_thumb_selected"):$(this).addClass("spud_admin_photo_ui_thumb_selected")},this.markPhotoAsDeleted=function(o){var e=$("#spud_admin_photo_"+o);e.fadeOut(200,function(){e.remove()})},this.markPhotoAlbumAsDeleted=function(o){var e=$("#spud_admin_photo_album_"+o);e.fadeOut(200,function(){e.remove()})},this.markPhotoGalleryAsDeleted=function(o){var e=$("#spud_admin_photo_gallery_"+o);e.fadeOut(200,function(){e.remove()})},this.submittedPhotoForm=function(){if(e){var t=new FormData,d=$(this);t.append("_method",d.find("[name=_method]").val()),t.append("authenticity_token",d.find("[name=authenticity_token]").val()),t.append("spud_photo[title]",d.find("#spud_photo_title").val()),t.append("spud_photo[caption]",d.find("#spud_photo_caption").val());var a,n=d.find("#spud_photo_photo")[0].files[0];n?(a=o.progressBarForUpload(n.name),t.append("spud_photo[photo]",n),d.append(a)):a=o.progressBarForUpload("");var s=new XMLHttpRequest;return s.upload.addEventListener("progress",function(e){o.onPhotoUploadProgress(e,a)},!1),s.addEventListener("load",function(e){o.onPhotoUploadComplete(e,a)},!1),s.addEventListener("error",function(e){o.onPhotoUploadFailure(e,a)},!1),s.addEventListener("abort",function(e){o.onPhotoUploadCancel(e,a)},!1),s.open("POST",d.attr("action")),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),s.send(t),!1}},this.progressBarForUpload=function(o){var e=['<div class="spud_admin_photo_progress">',"<h6>",'<span class="spud_admin_photo_progress_filename">'+o+"</span>: ",'<span class="spud_admin_photo_progress_status">Uploading</span>',"</h6>",'<div class="progress progress-striped active">','<div class="bar" style="width: 0;"></div>',"</div>","</div>"].join("");return $(e)},this.onPhotoUploadProgress=function(o,e){var t=Math.round(100*o.loaded/o.total);e.find(".bar").css({width:t+"%"}),100==t&&(e.find(".progress").addClass("progress-success"),e.find(".spud_admin_photo_progress_status").text("Processing"))},this.onPhotoUploadComplete=function(o,e){var t=$.parseJSON(o.target.response);if(200==o.target.status){e.find(".spud_admin_photo_progress_status").text("Done!"),e.find(".progress").removeClass("progress-striped active");var d=$("#spud_admin_photo_"+t.id);if(d.length>0)d.replaceWith(t.html);else{var a=$("#spud_admin_photos_selected, #spud_admin_photos");a.prepend(t.html).fadeIn(200)}hideModalDialog()}else $("#modal_window .modal-body").html(t.html)},this.onPhotoUploadCancel=function(o,e){e.find(".spud_admin_photo_progress_status").text("Done!"),e.find(".progress").addClass("progress-danger")},this.clickedPhotoAddOrEdit=function(){var e=this.href;return $.ajax({url:e,success:o.photoUploadFormLoaded}),!1},this.photoUploadFormLoaded=function(o){displayModalDialogWithOptions({title:"Upload Photo",html:o})},this.clickedPhotoLibrary=function(){var e=this.href;return $.ajax({url:e,success:o.photoLibraryLoaded}),!1},this.photoLibraryLoaded=function(o){var e=$("#modal_window");$("#spud_admin_photos_selected .spud_admin_photo_ui_thumb").each(function(){var o=$(this).attr("id"),t=e.find("#"+o);t&&t.remove()}),displayModalDialogWithOptions({title:"My Photo Library",html:o,buttons:{"spud_admin_photo_library_add_selected btn-primary":"Add Selected","spud_admin_photo_library_delete_selected btn-danger":"Delete Selected"}})},this.addSelectedPhotosFromLibrary=function(){$("#spud_admin_photo_library .spud_admin_photo_ui_thumb_selected").removeClass("spud_admin_photo_ui_thumb_selected").prependTo("#spud_admin_photos_selected").hide().fadeIn(200),hideModalDialog()},this.deleteSelectedPhotosFromLibrary=function(){var o=$.map($(".spud_admin_photo_ui_thumb_selected"),function(o){return $(o).attr("rel")});$.ajax({type:"POST",url:"/spud/admin/photos/mass_destroy",data:{spud_photo_ids:o},success:function(){$(".spud_admin_photo_ui_thumb_selected").fadeOut(200,function(){$(this).remove()})},error:function(){console.log("An error occurred:"),console.log(arguments)}})},this.fileQueue=[],this.fileQueueStarted=!1,this.stopDndPropagation=function(o){o.stopPropagation(),o.preventDefault()},this.droppedFile=function(e){e.stopPropagation(),e.preventDefault(),$("#spud_admin_photo_upload_queue").show();for(var t=e.dataTransfer.files,d=0;d<t.length;)o.fileQueue.push(t[d]),d++;o.updateQueueCountLabel(),this.fileQueueStarted||(o.uploadNextPhoto(),o.fileQueue.length>0&&o.uploadNextPhoto())},this.updateQueueCountLabel=function(){$("#spud_admin_photo_upload_queue_label span").text(o.fileQueue.length)},this.uploadNextPhoto=function(){if(0===o.fileQueue.length)return o.fileQueueStarted=!1,void 0;o.fileQueueStarted=!0;var e=o.fileQueue.pop(),t=new FormData;t.append("spud_photo[photo]",e);var d=o.progressBarForUpload(e.name);$("#spud_admin_photo_upload_queue_bars").prepend(d);var a=new XMLHttpRequest;a.upload.addEventListener("progress",function(e){o.onPhotoUploadProgress(e,d)},!1),a.addEventListener("load",function(e){o.onQueuedPhotoUploadComplete(e,d)},!1),a.addEventListener("error",function(e){o.onPhotoUploadFailure(e,d)},!1),a.addEventListener("abort",function(e){o.onPhotoUploadCancel(e,d)},!1),a.open("POST","/spud/admin/photos"),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.send(t)},this.onQueuedPhotoUploadComplete=function(e,t){o.onPhotoUploadComplete(e,t),o.updateQueueCountLabel(),o.uploadNextPhoto()}};